<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | 2026 éšç§åŠ å¯†ç¬”è®°</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .note-card {
            transition: all 0.3s ease;
        }

        .note-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.9);
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar {
            width: 0px;
        }

        /* Markdown é¢„è§ˆæ ·å¼ */
        .markdown-preview {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
        }

        .markdown-preview h1 {
            font-size: 2em;
            font-weight: 800;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview p {
            margin-bottom: 1em;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-preview li {
            margin-bottom: 0.5em;
        }

        .markdown-preview code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-preview pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1.5em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1.5em;
            color: #94a3b8;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1.5em;
        }

        .markdown-preview th, .markdown-preview td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75em;
            text-align: left;
        }

        .markdown-preview th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .markdown-preview a {
            color: #60a5fa;
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        .markdown-preview img {
            max-width: 100%;
            border-radius: 0.5em;
            margin-bottom: 1em;
        }

        .markdown-preview hr {
            border: none;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 2em 0;
        }

        /* Tab åˆ‡æ¢æ ·å¼ */
        .tab-button {
            padding: 0.75em 1.5em;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 0.5em;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button.active {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        /* ä»£ç é«˜äº® */
        .hljs {
            background: transparent !important;
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <div id="app" class="max-w-4xl mx-auto px-4 py-8 md:py-12">
        <!-- åŠ¨æ€åŠ è½½åŒº -->
    </div>

    <!-- æç®€è®¾ç½®å¼¹çª— -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">Worker
                        æœåŠ¡åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— - å¤§å¹…å¢åŠ æ–‡æœ¬è¾“å…¥çª—å£é«˜åº¦ -->
    <div id="editModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-4xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[95vh] overflow-hidden flex flex-col">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">âœï¸</span> ç¼–è¾‘ç¬”è®°
                <span id="editNoteId" class="text-sm text-slate-400 ml-2 font-mono"></span>
            </h2>
            
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('edit')" class="tab-button active" id="editTabBtn">ç¼–è¾‘æ¨¡å¼</button>
                <button onclick="switchTab('preview')" class="tab-button" id="previewTabBtn">é¢„è§ˆæ¨¡å¼</button>
            </div>
            
            <div class="space-y-4 flex-1 overflow-hidden flex flex-col min-h-0">
                <div id="editTab" class="flex-1 flex flex-col min-h-0">
                    <div class="flex gap-2 flex-wrap mb-3">
                        <button onclick="insertMarkdown('# ', 'æ ‡é¢˜')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">H1</button>
                        <button onclick="insertMarkdown('## ', 'äºŒçº§æ ‡é¢˜')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">H2</button>
                        <button onclick="insertMarkdown('**', 'ç²—ä½“æ–‡æœ¬')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">ç²—ä½“</button>
                        <button onclick="insertMarkdown('*', 'æ–œä½“æ–‡æœ¬')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">æ–œä½“</button>
                        <button onclick="insertMarkdown('- ', 'åˆ—è¡¨é¡¹')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">åˆ—è¡¨</button>
                        <button onclick="insertMarkdown('```javascript\n\n```', 'ä»£ç ')" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700 transition text-sm">ä»£ç å—</button>
                    </div>
                    
                    <div class="flex-1 min-h-0">
                        <!-- å°†æ–‡æœ¬è¾“å…¥åŒºåŸŸé«˜åº¦å¢åŠ åˆ°åŸæ¥çš„ä¸‰å€ -->
                        <textarea id="editNoteContent" 
                            class="w-full h-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all resize-none leading-relaxed font-mono min-h-[60vh]"
                            placeholder="# æ ‡é¢˜&#10;&#10;## äºŒçº§æ ‡é¢˜&#10;&#10;- åˆ—è¡¨é¡¹&#10;- å¦ä¸€ä¸ªåˆ—è¡¨é¡¹&#10;&#10;**ç²—ä½“** *æ–œä½“*&#10;&#10;```javascript&#10;// ä»£ç å—&#10;console.log('Hello');&#10;```"></textarea>
                    </div>
                    
                    <div class="flex items-center gap-4 text-xs text-slate-500 mt-3">
                        <div class="flex-1">
                            <button onclick="showMarkdownHelp()" class="text-blue-400 hover:text-blue-300 transition text-sm">ğŸ“– Markdown è¯­æ³•å¸®åŠ©</button>
                        </div>
                        <span id="editCharCount">0</span> å­—ç¬¦
                    </div>
                </div>
                
                <div id="previewTab" class="flex-1 overflow-y-auto hidden min-h-0">
                    <div class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        Markdown é¢„è§ˆ
                    </div>
                    <div id="markdownPreview" class="markdown-preview p-5 bg-slate-950/50 border border-slate-800 rounded-2xl flex-1 overflow-y-auto min-h-[60vh]">
                        <!-- Markdown é¢„è§ˆå†…å®¹ -->
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 pt-6 border-t border-white/5">
                <button onclick="closeEdit()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">
                    ä¿å­˜æ›´æ”¹
                </button>
            </div>
            
            <div class="pt-4 border-t border-white/5 text-xs text-slate-500">
                <p class="flex items-center gap-2">
                    <span class="text-yellow-400">âš ï¸</span>
                    æ³¨æ„ï¼šç¼–è¾‘åç¬”è®°å°†ä½¿ç”¨å½“å‰ä¸»å¯†ç é‡æ–°åŠ å¯†ä¿å­˜åˆ°äº‘ç«¯
                </p>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let apiFromUrl = urlParams.get('api');
        const cfgFromUrl = urlParams.get('cfg');
        if (cfgFromUrl) { try { apiFromUrl = atob(cfgFromUrl); } catch (e) { } }
        const shareId = urlParams.get('share');

        let API_URL = apiFromUrl || localStorage.getItem('cf_notes_api') || "";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";

        // å½“å‰ç¼–è¾‘çš„ç¬”è®°ID
        let currentEditId = null;
        // å…¨å±€ç¼“å­˜ç¬”è®°æ•°æ®
        let notesCache = {};

        const app = document.getElementById('app');

        // åŠ è§£å¯†é€»è¾‘
        async function getK(pw) {
            const enc = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', enc.encode(pw));
            return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }
        
        async function encrypt(text, pw) {
            const enc = new TextEncoder(); 
            const iv = crypto.getRandomValues(new Uint8Array(12)); 
            const key = await getK(pw);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
        }
        
        async function decrypt(json, pw) {
            try {
                const { iv, data } = JSON.parse(atob(json)); 
                const key = await getK(pw);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, new Uint8Array(data));
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        // Markdown é…ç½®
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (__) {}
                }
                return code;
            }
        });

        function init() {
            if (shareId) renderShareView();
            else if (!API_URL) renderWelcomeView();
            else renderMainView();
        }

        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-blue-500/10 rounded-full text-5xl">ğŸ›¡ï¸</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed">æ‚¨çš„ä¸“å±åˆ†å¸ƒå¼åŠ å¯†ç¬”è®°ç³»ç»Ÿ<br>è¯·å…ˆå…³è”æ‚¨çš„ Cloudflare Worker åç«¯</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-blue-500 font-black">ç«¯åˆ°ç«¯åŠ å¯†ä¿é™©åº“ | æ”¯æŒ Markdown</p>
                    </div>
                    <button onclick="configUrl()" class="p-4 glass rounded-2xl hover:rotate-180 transition-all duration-500 text-xl">âš™ï¸</button>
                </header>

                <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5">
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                                è§£å¯†ä¸»å¯†ç 
                            </label>
                            <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ä»¥åŠ å¯†/è§£å¯†æ•°æ®" 
                                class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 block">
                                    ç¬”è®°å†…å®¹ (æ”¯æŒ Markdown æ ¼å¼)
                                </label>
                                <button onclick="showMarkdownHelp()" class="text-xs text-blue-400 hover:text-blue-300 transition">ğŸ“– Markdown è¯­æ³•å¸®åŠ©</button>
                            </div>
                            <textarea id="noteInput" placeholder="# è¾“å…¥æ‚¨çš„ Markdown ç¬”è®°...&#10;&#10;## æ”¯æŒåŠŸèƒ½&#10;- æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—&#10;- **ç²—ä½“**ã€*æ–œä½“*ã€[é“¾æ¥]()&#10;- è¡¨æ ¼ã€å¼•ç”¨ã€åˆ†å‰²çº¿" 
                                class="w-full bg-slate-950/50 border border-slate-800 p-5 h-64 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed font-mono"></textarea>
                            <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                                <span id="noteCharCount">0</span> å­—ç¬¦
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="doSave()" class="gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:shadow-lg transition">åŠ å¯†å­˜å…¥äº‘ç«¯</button>
                        <button onclick="doAI()" class="glass text-purple-400 py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ™ºèƒ½æ€»ç»“</button>
                    </div>
                </main>

                <section class="space-y-6">
                    <div class="flex justify-between items-center px-4">
                        <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault / æˆ‘çš„åŠ å¯†åº“</h2>
                        <div class="flex gap-2">
                            <button onclick="showMarkdownHelp()" class="text-blue-400 text-xs font-black hover:underline">Markdown è¯­æ³•</button>
                            <button onclick="loadList()" class="text-blue-500 text-xs font-black hover:underline uppercase">åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                    </div>
                    <div id="notesList" class="space-y-6">
                        <div class="text-center py-20 text-slate-600 italic text-sm">é…ç½®å®Œæˆåè¾“å…¥å¯†ç å¹¶ç‚¹å‡»åˆ·æ–°ã€‚</div>
                    </div>
                </section>
                
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </footer>
            </div>
        `;
            
            // æ·»åŠ å­—ç¬¦è®¡æ•°ç›‘å¬
            const noteInput = document.getElementById('noteInput');
            const noteCharCount = document.getElementById('noteCharCount');
            if (noteInput && noteCharCount) {
                noteInput.addEventListener('input', function() {
                    noteCharCount.textContent = this.value.length;
                });
            }
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] shadow-2xl text-center space-y-8 animate-in zoom-in duration-500">
                <div class="text-6xl animate-bounce">ğŸ”¥</div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-black italic">é˜…åå³ç„šè§£å¯†</h1>
                    <p class="text-slate-400 text-sm">è§£å¯†åæ•°æ®å°†ç«‹å³ä»æœåŠ¡å™¨ç‰©ç†æ“¦é™¤</p>
                </div>
                <input id="sharePw" type="password" placeholder="è¯·è¾“å…¥ 6 ä½ä»¥ä¸Šè§£å¯†å¯†ç " class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono">
                <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">è§£å¯†å¹¶é”€æ¯</button>
                <div id="shareResult" class="mt-8 text-left p-6 bg-slate-950/50 rounded-2xl hidden markdown-preview leading-relaxed border border-orange-500/20 ring-1 ring-orange-500/10 shadow-inner"></div>
                <div class="pt-8 border-t border-white/5">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </div>
            </div>
        `;
        }

        /* --- åŠŸèƒ½é€»è¾‘ --- */
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        
        function closeSettings() { 
            document.getElementById('settingsModal').classList.add('hidden'); 
        }
        
        function saveSettings() {
            localStorage.setItem('cf_notes_api', document.getElementById('setApi').value);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            location.reload();
        }

        // Markdown è¾…åŠ©å‡½æ•°
        function showMarkdownHelp() {
            const helpContent = `# Markdown è¯­æ³•é€ŸæŸ¥

## æ ‡é¢˜
\`# ä¸€çº§æ ‡é¢˜\`
\`## äºŒçº§æ ‡é¢˜\`
\`### ä¸‰çº§æ ‡é¢˜\`

## æ–‡æœ¬æ ·å¼
- **ç²—ä½“**: \`**ç²—ä½“æ–‡æœ¬**\`
- *æ–œä½“*: \`*æ–œä½“æ–‡æœ¬*\`
- ~~åˆ é™¤çº¿~~: \`~~åˆ é™¤æ–‡æœ¬~~\`
- \`è¡Œå†…ä»£ç \`: \`\` ä»£ç  \`\`

## åˆ—è¡¨
- æ— åºåˆ—è¡¨: \`- é¡¹ç›®\`
- æœ‰åºåˆ—è¡¨: \`1. é¡¹ç›®\`

## é“¾æ¥ä¸å›¾ç‰‡
- [é“¾æ¥](https://example.com): \`[é“¾æ¥æ–‡æœ¬](URL)\`
- ![å›¾ç‰‡](https://example.com/image.jpg): \`![æ›¿ä»£æ–‡æœ¬](å›¾ç‰‡URL)\`

## ä»£ç å—
\`\`\`javascript
// JavaScript ä»£ç 
console.log('Hello');
\`\`\`

## å¼•ç”¨
> å¼•ç”¨å†…å®¹: \`> å¼•ç”¨æ–‡æœ¬\`

## è¡¨æ ¼
| è¡¨å¤´ | è¡¨å¤´ |
|------|------|
| å†…å®¹ | å†…å®¹ |

## åˆ†å‰²çº¿
\`---\` æˆ– \`***\`

## ä»»åŠ¡åˆ—è¡¨
- [ ] æœªå®Œæˆä»»åŠ¡
- [x] å·²å®Œæˆä»»åŠ¡`;

            alert(helpContent);
        }

        function switchTab(tabName) {
            const editTab = document.getElementById('editTab');
            const previewTab = document.getElementById('previewTab');
            const editTabBtn = document.getElementById('editTabBtn');
            const previewTabBtn = document.getElementById('previewTabBtn');
            const editContent = document.getElementById('editNoteContent');
            
            if (tabName === 'edit') {
                editTab.classList.remove('hidden');
                previewTab.classList.add('hidden');
                editTabBtn.classList.add('active');
                previewTabBtn.classList.remove('active');
            } else {
                editTab.classList.add('hidden');
                previewTab.classList.remove('hidden');
                editTabBtn.classList.remove('active');
                previewTabBtn.classList.add('active');
                
                // æ›´æ–°é¢„è§ˆ
                const previewDiv = document.getElementById('markdownPreview');
                previewDiv.innerHTML = marked.parse(editContent.value || '');
                hljs.highlightAll();
            }
        }

        function insertMarkdown(syntax, placeholder) {
            const textarea = document.getElementById('editNoteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (selectedText) {
                // å¦‚æœå·²é€‰æ‹©æ–‡æœ¬ï¼Œåˆ™å›´ç»•å®ƒæ’å…¥è¯­æ³•
                const newText = syntax + selectedText + (syntax.startsWith('*') || syntax.startsWith('_') ? syntax : '');
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + newText.length;
            } else {
                // å¦‚æœæœªé€‰æ‹©æ–‡æœ¬ï¼Œåˆ™æ’å…¥è¯­æ³•å’Œå ä½ç¬¦
                const placeholderText = syntax.includes('\n') ? syntax.replace('\n\n```', '\n' + placeholder + '\n```') : syntax + placeholder;
                textarea.value = textarea.value.substring(0, start) + placeholderText + textarea.value.substring(end);
                textarea.selectionStart = start + syntax.length;
                textarea.selectionEnd = start + placeholderText.length;
            }
            
            textarea.focus();
            updateCharCount();
        }

        function updateCharCount() {
            const textarea = document.getElementById('editNoteContent');
            const charCount = document.getElementById('editCharCount');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        async function doSave(content, id = null) {
            const text = content || document.getElementById('noteInput').value;
            const pw = document.getElementById('mainPw').value;
            
            if (!text || !pw) {
                alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
                return null;
            }
            
            try {
                // åŠ å¯†å†…å®¹
                const cipher = await encrypt(text, pw);
                
                // æ„å»ºè¯·æ±‚ä½“
                const body = { content: cipher };
                
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ ID
                if (id !== null) {
                    body.id = id;
                }
                
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify(body)
                });
                
                if (res.ok) { 
                    if (id === null) {
                        alert("âœ… å·²å­˜å…¥å®‰å…¨åº“"); 
                        document.getElementById('noteInput').value = ""; 
                        document.getElementById('noteCharCount').textContent = "0";
                    } else {
                        alert("âœ… ç¬”è®°å·²æ›´æ–°");
                    }
                    loadList();
                    return true;
                } else {
                    alert("âŒ ä¿å­˜å¤±è´¥");
                    return false;
                }
            } catch (e) { 
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥"); 
                return false;
            }
        }

        async function loadList() {
            const pw = document.getElementById('mainPw').value; 
            if (!pw) return alert("è¯·è¾“å…¥å¯†ç è§£å¯†");
            
            const listDiv = document.getElementById('notesList');
            listDiv.innerHTML = '<div class="text-center py-12 text-slate-600 italic text-sm">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json(); 
                listDiv.innerHTML = "";
                
                if (notes.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                // æ¸…ç©ºç¼“å­˜
                notesCache = {};
                
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw);
                    if (!clearText) {
                        continue; // è·³è¿‡å¯†ç ä¸åŒ¹é…çš„ç¬”è®°
                    }
                    
                    // ç¼“å­˜ç¬”è®°å†…å®¹
                    notesCache[n.id] = {
                        id: n.id,
                        clearText: clearText,
                        created_at: n.created_at
                    };
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸º Markdown å†…å®¹ï¼ˆç®€å•æ£€æµ‹ï¼‰
                    const isMarkdown = clearText.includes('# ') || clearText.includes('## ') || clearText.includes('```') || 
                                       clearText.includes('**') || clearText.includes('- ') || clearText.includes('> ');
                    
                    const card = document.createElement('div');
                    card.className = "note-card glass p-6 rounded-3xl space-y-4 border border-white/5 shadow-lg group";
                    
                    // åˆ›å»ºé¢„è§ˆå†…å®¹ï¼ˆå¦‚æœå†…å®¹å¤ªé•¿åˆ™æˆªæ–­ï¼‰
                    let previewContent = clearText;
                    let showFullButton = false;
                    
                    if (clearText.length > 300) {
                        previewContent = clearText.substring(0, 300) + '...';
                        showFullButton = true;
                    }
                    
                    // æ¸²æŸ“é¢„è§ˆå†…å®¹ï¼ˆMarkdown æˆ–çº¯æ–‡æœ¬ï¼‰
                    const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                            `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                    
                    card.innerHTML = `
                    <div class="flex justify-between text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                        <span>ç´¢å¼•ç¼–å· #${n.id}</span>
                        <span>${new Date(n.created_at).toLocaleString()}</span>
                    </div>
                    <div class="markdown-preview text-slate-300 text-sm leading-relaxed" id="noteContent-${n.id}">
                        ${renderedContent}
                        ${showFullButton ? `<button onclick="toggleNoteContent(${n.id})" class="text-blue-400 text-xs mt-2 hover:underline transition">æ˜¾ç¤ºå…¨éƒ¨</button>` : ''}
                    </div>
                    <div class="pt-4 border-t border-white/5 flex flex-wrap gap-4 items-center">
                        <button onclick="doShareCopy('${n.content.replace(/'/g, "\\'")}')" class="text-xs font-black text-blue-400 uppercase tracking-widest hover:text-blue-300 transition">ğŸ“¤ ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
                        <button onclick="doExport(\`${clearText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, ${n.id})" class="text-xs font-black text-emerald-500 uppercase tracking-widest hover:text-emerald-400 transition">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
                        <button onclick="openEdit(${n.id}, \`${clearText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="text-xs font-black text-amber-500 uppercase tracking-widest hover:text-amber-400 transition">âœï¸ ç¼–è¾‘</button>
                        <button onclick="doDelete(${n.id})" class="text-xs font-black text-rose-500 uppercase tracking-widest ml-auto opacity-40 group-hover:opacity-100 transition">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                `;
                    listDiv.appendChild(card);
                }
                
                // é«˜äº®ä»£ç å—
                hljs.highlightAll();
            } catch (e) { 
                console.error('åŠ è½½åˆ—è¡¨å¤±è´¥:', e);
                listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        }

        // ä¿®å¤çš„ toggleNoteContent å‡½æ•°
        function toggleNoteContent(id) {
            const contentDiv = document.getElementById(`noteContent-${id}`);
            const note = notesCache[id];
            
            if (!note) {
                console.error('æœªæ‰¾åˆ°ç¬”è®°ç¼“å­˜:', id);
                return;
            }
            
            const currentContent = contentDiv.innerHTML;
            const showFullText = currentContent.includes('æ˜¾ç¤ºå…¨éƒ¨');
            
            // åˆ¤æ–­æ˜¯å¦ä¸º Markdown å†…å®¹
            const isMarkdown = note.clearText.includes('# ') || note.clearText.includes('## ') || 
                               note.clearText.includes('```') || note.clearText.includes('**') ||
                               note.clearText.includes('- ') || note.clearText.includes('> ');
            
            if (showFullText) {
                // æ˜¾ç¤ºå…¨éƒ¨å†…å®¹
                const renderedContent = isMarkdown ? marked.parse(note.clearText) : 
                                        `<div class="whitespace-pre-wrap">${note.clearText.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<button onclick="toggleNoteContent(${id})" class="text-blue-400 text-xs mt-2 hover:underline transition">æ”¶èµ·</button>`;
                
                // é‡æ–°é«˜äº®ä»£ç å—
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            } else {
                // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
                let previewContent = note.clearText;
                if (note.clearText.length > 300) {
                    previewContent = note.clearText.substring(0, 300) + '...';
                }
                
                const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                        `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<button onclick="toggleNoteContent(${id})" class="text-blue-400 text-xs mt-2 hover:underline transition">æ˜¾ç¤ºå…¨éƒ¨</button>`;
            }
        }

        // ==================== æ–°å¢ç¼–è¾‘åŠŸèƒ½ ====================
        function openEdit(id, content) {
            currentEditId = id;
            document.getElementById('editNoteId').textContent = `#${id}`;
            document.getElementById('editNoteContent').value = content;
            
            // æ›´æ–°å­—ç¬¦è®¡æ•°
            updateCharCount();
            
            // ç›‘å¬è¾“å…¥æ›´æ–°å­—ç¬¦è®¡æ•°
            const textarea = document.getElementById('editNoteContent');
            textarea.addEventListener('input', updateCharCount);
            
            // åˆ‡æ¢åˆ°ç¼–è¾‘æ ‡ç­¾
            switchTab('edit');
            
            document.getElementById('editModal').classList.remove('hidden');
            
            // èšç„¦åˆ°æ–‡æœ¬åŒºåŸŸ
            setTimeout(() => {
                textarea.focus();
            }, 100);
        }
        
        function closeEdit() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }
        
        async function saveEdit() {
            const newContent = document.getElementById('editNoteContent').value;
            
            if (!newContent.trim()) {
                alert("ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º");
                return;
            }
            
            // ç›´æ¥è°ƒç”¨ doSave å‡½æ•°æ¥ä¿å­˜ç¼–è¾‘åçš„å†…å®¹
            const success = await doSave(newContent, currentEditId);
            
            if (success) {
                closeEdit();
            }
        }

        async function doShareCopy(cipher) {
            const pid = Math.random().toString(36).substring(2, 12);
            try {
                await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher, public_id: pid, is_share: 1 })
                });
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}&cfg=${btoa(API_URL)}`;
                prompt("âœ… é˜…åå³ç„šåŠ å¯†é“¾æ¥å·²ç”Ÿæˆï¼š", fullUrl);
            } catch (e) { alert("åˆ†äº«å¤±è´¥"); }
        }

        function doExport(text, id) {
            const date = new Date().toISOString().split('T')[0];
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `CloudNote_${id}_${date}.md`; 
            a.click();
        }

        async function doDelete(id) {
            if (!confirm("ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; 
            if (!text) return alert("ç¬”è®°ä¸ºç©º");
            const btn = event.target; 
            btn.innerText = "æ€è€ƒä¸­..."; 
            btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                document.getElementById('noteInput').value += `\n\n--- âœ¨ AI æ€»ç»“ ---\n\n${data.summary}`;
                // æ›´æ–°å­—ç¬¦è®¡æ•°
                document.getElementById('noteCharCount').textContent = document.getElementById('noteInput').value.length;
            } finally { 
                btn.innerText = "âœ¨ AI æ™ºèƒ½æ€»ç»“"; 
                btn.disabled = false; 
            }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value; 
            const resDiv = document.getElementById('shareResult');
            try {
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) return alert("å¤±æ•ˆæˆ–å·²è¢«ç„šæ¯");
                const data = await res.json(); 
                const clearText = await decrypt(data.content, pw);
                if (clearText) { 
                    // æ¸²æŸ“ Markdown
                    resDiv.innerHTML = marked.parse(clearText);
                    hljs.highlightAll();
                    resDiv.classList.remove('hidden'); 
                    document.getElementById('unlockBtn').disabled = true; 
                    document.getElementById('unlockBtn').innerText = "æ•°æ®å·²é”€æ¯";
                }
                else alert("å¯†ç é”™è¯¯");
            } catch (e) { alert("ç½‘ç»œå¼‚å¸¸"); }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('Service Worker Registration Failed', err));
        }

        init();
    </script>
</body>

</html>
